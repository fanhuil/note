# 通过 Eloquent 模型实现批量赋值和软删除

在[上一篇教程](https://laravelacademy.org/post/9699.html)中，我们基于 Eloquent 模型实现了对数据表记录的增删改查操作，今天我们在此基础上介绍两个 Eloquent 模型提供的高级功能 —— 批量赋值和软删除。

### 批量赋值

批量赋值主要用于快速设置模型属性。

在介绍批量赋值之前，我们先看一个例子，之前我们新增或者修改 Eloquent 模型时都是通过依次设置每个属性来实现的：

```php
$post = new App\Post;
$post->title = '测试文章标题';
$post->content = '测试文章内容';
$post->user_id = 1;
$post->save();
```

如果模型类就那么三五个属性还好，如果是十几个甚至几十个呢？每次这么做得崩溃掉，到时候我们的控制器类里面可能会遍布这种设置代码，Laravel 号称的优雅就是打脸了。所以这个时候，批量赋值就粉墨登场了，批量赋值就是为我们解决这个问题的。

#### 创建模型

以创建模型实例为例，批量赋值允许我们以数组的方式将待设置属性以关联数组的方式传递构造函数：

```php
$post = new Post([
    'title' => '测试文章标题', 
    'content' => '测试文章内容'
]);
```

仅这么看的话，好像跟之前的写法没有什么大的优势，还是需要指定每个属性，但是这为我们提供了一个很好的基础，如果和用户请求数据结合起来使用，就能焕发它的光彩了。比如，如果我们的请求数据是一个文章发布表单提交过来的数据，包含 `title`、`content` 等字段信息，就可以通过下面这种方式进行批量赋值了：

```php
$post = new Post($request->all());
```

这样一来，不管多少字段，一条语句就搞定了全部属性的赋值。但是，细心的同学可能会发现，这里有一个安全隐患，如果用户发布的时候，包含了用户字段 `user_id`，并且设置的不是自己的用户 ID，而是其它用户的 ID，发布出来的文章就变成其他人发布的了；又或者文章需要审核后才能发布，但用户在表单中传递了状态字段将文章状态设置为审核通过，这样文章保存后就直接是已发布状态了。诸如此类的问题还有很多，总而言之，批量赋值给我们带来便利的同时，也给我们带来了烦恼。

作为一个成熟的 ORM 框架，Eloquent 在设计之初肯定不会没有考虑到这样的问题，实际上，我们可以借助模型类中的白名单属性或黑名单属性来解决这个困扰。

所谓白名单属性就是该属性中指定的字段才能应用批量赋值，不在白名单中的属性会被忽略；与之相对的，黑名单属性指定的字段不会应用批量赋值，不在黑名单中的属性则会应用批量赋值。可以看到，这两个属性是互斥的，只要设置一个属性就可以解决所有问题了，不要同时设置两个属性。

Eloquent 模型类默认白名单属性为空，黑名单属性为 `*`，即所有字段都不会应用批量赋值：

```php
/**
 * 使用批量赋值的属性（白名单）
 *
 * @var array
 */
protected $fillable = [];

/**
 * 不使用批量赋值的字段（黑名单）
 *
 * @var array
 */
protected $guarded = ['*'];
```

我们在实际开发中，对于频繁变动的数据表，建议使用白名单，这样安全性更好，因为哪些字段应用批量赋值始终是可控的，黑名单则会在后续新增字段的时候容易遗漏。而对于相对稳定或者字段很多的数据表，建议使用黑名单，免去设置字段之苦，但是对于这样的模型类，每次修改数据表结构的时候都要记得维护这个黑名单，看看是否需要变动。

所以，以 `Post` 模型为例，我们需要为其设置一个黑名单字段：

```php
protected $guarded = ['user_id'];
```

白名单和黑名单都是以数组属性，支持设置多个字段。这样设置就代表除了 `user_id` 字段之外，所有其它字段都支持批量赋值。

那排除在批量赋值之外的字段怎么设置呢？只能通过模型属性来设置了：

```php
$post = new Post($request->all());
$post->user_id = 0;
$post->save();
```































